!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("Coveo")):"function"==typeof define&&define.amd?define(["Coveo"],t):"object"==typeof exports?exports.CoveoForZendeskAgent=t(require("Coveo")):e.CoveoForZendeskAgent=t(e.Coveo)}(window,(function(e){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(n,o,function(t){return e[t]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/commonjs",i(i.s=1)}([function(t,i){t.exports=e},function(e,t,i){"use strict";i.r(t),i.d(t,"ZendeskClient",(function(){return o})),i.d(t,"InitializationHandler",(function(){return f})),i.d(t,"InsightPanel",(function(){return v})),i.d(t,"TopBar",(function(){return g})),i.d(t,"init",(function(){return y}));var n=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}a((n=n.apply(e,t||[])).next())}))};class o{constructor(){}getClient(){return this.client||(this.client=ZAFClient.init()),this.client}getSettings(){return n(this,void 0,void 0,(function*(){return this.metadata||(this.metadata=yield this.getClient().metadata()),this.metadata.settings}))}getTicketFields(){return n(this,void 0,void 0,(function*(){if(!this.zendeskFields){var e=(yield this.getClient().get("ticketFields")).ticketFields.filter(e=>"built-in"!=e.type).map(e=>({name:"customField:"+e.name,label:e.label?e.label:e.name})),t=(yield this.getClient().request({url:"/api/v2/ticket_fields.json",type:"GET",dataType:"json"})).ticket_fields.map(e=>({name:e.type,label:e.title}));this.zendeskFields=t.concat(e)}return Promise.resolve(this.zendeskFields)}))}}var s,r=i(0),c=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}a((n=n.apply(e,t||[])).next())}))};!function(e){e.Search="SEARCH",e.Click="CLICK",e.PageView="VIEW",e.Custom="CUSTOM"}(s||(s={}));class a{constructor(e){this.options=e,r.Assert.exists(this.options.accessToken),r.Assert.exists(this.options.organization),this.options.uri=this.options.uri?this.options.uri:a.DEFAULT_URI,this.options.accessToken.subscribeToRenewal(this.buildEndpointCaller.bind(this)),this.buildEndpointCaller(this.options.accessToken.token)}buildEndpointCaller(e){this.caller=new r.EndpointCaller({accessToken:e})}getActions(e){return c(this,void 0,void 0,(function*(){r.Assert.exists(e);const t=yield this.caller.call({method:"POST",url:`${this.options.uri}/rest/organizations/${this.options.organization}/machinelearning/user/actions`,queryString:[],responseType:"json",requestDataType:"application/json",requestData:{objectId:e},errorsAsSuccess:!1});if(this.isResponseEmpty(t))throw new Error("Response has no values: "+JSON.stringify(t));return this.parseResponse(t.data)}))}parseResponse(e){return e.value.map(e=>({time:parseInt(e.time),value:JSON.parse(e.value),name:e.name}))}isResponseEmpty(e){return!(e&&e.data&&e.data.value&&Array.isArray(e.data.value)&&e.data.value.length>0)}}a.DEFAULT_URI="https://platform.cloud.coveo.com";var u=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}a((n=n.apply(e,t||[])).next())}))};class l{constructor(e,t,i,n,o){this.type=e,this.timestamp=t,this.raw=i,this.document=n,this.query=o}}class h extends r.Model{constructor(e,t){super(e,h.ID,{}),this.options=t,r.Assert.isNotUndefined(this.options.restUri),r.Assert.isNotUndefined(this.options.organizationId),r.Assert.isNotUndefined(this.options.searchEndpoint),this.getOrFetchCache={},this.endpoint=new a({uri:this.options.restUri,accessToken:this.options.accessToken||this.options.searchEndpoint.accessToken,organization:this.options.organizationId})}getActions(e){return u(this,void 0,void 0,(function*(){let t=this.get(e);return t=Array.isArray(t)?t:yield this.fetchActions(e),this.set(e,t,h.MODEL_CONFIG),t}))}deleteActions(e){this.set(e,void 0,h.MODEL_CONFIG),this.getOrFetchCache[e]=void 0}fetchActions(e){return this.getOrFetchCache[e]||(()=>(this.getOrFetchCache[e]=this.endpoint.getActions(e).then(t=>this.parseGetActionsResponse(e,t)),this.getOrFetchCache[e]))()}parseGetActionsResponse(e,t){const i=this.buildUserActions(t);return this.registerNewAttribute(e,i),i}fetchDocuments(e){return u(this,void 0,void 0,(function*(){if(0===e.length)return Promise.resolve({});const t=new r.QueryBuilder;return t.advancedExpression.addFieldExpression("@urihash","==",e.filter(e=>e)),t.numberOfResults=e.length,(yield this.options.searchEndpoint.search(t.build())).results.reduce((e,t)=>Object.assign(Object.assign({},e),{[t.raw.urihash]:t}),{})}))}buildUserActions(e){return u(this,void 0,void 0,(function*(){let t={};const i=e.filter(this.isClick).map(e=>e.value.uri_hash).filter((e,t,i)=>i.indexOf(e)===t);try{t=yield this.fetchDocuments(i)}catch(e){this.logger.error(h.ERROR_MESSAGE.FETCH_CLICKED_DOCUMENT_FAIL,e)}return e.map(e=>new l(e.name,new Date(e.time),e.value,this.isClickOrView(e)?t[e.value.uri_hash]:void 0,this.isSearch(e)?e.value.query_expression:void 0))}))}isClick(e){return e.name===s.Click}isClickOrView(e){return this.isClick(e)||e.name===s.PageView}isSearch(e){return e.name===s.Search}}h.ID="UserProfileModel",h.ERROR_MESSAGE=Object.freeze({FETCH_CLICKED_DOCUMENT_FAIL:"Fetching clicked documents details failed"}),h.MODEL_CONFIG={customAttribute:!0,silent:!0},window.Coveo&&(window.Coveo.UserProfileModel=h);var d=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}a((n=n.apply(e,t||[])).next())}))};class f{constructor(e){this.zendeskClient=e,this.client=e}initializeSearchInterfaceWithUserActions(e,t,i){return d(this,void 0,void 0,(function*(){var n=yield this.client.getSettings();Coveo.SearchEndpoint.endpoints.default=new Coveo.SearchEndpoint({restUri:t.endpointUrl+"/rest/search",accessToken:t.searchToken,queryStringArguments:{organizationId:n.organizationId},renewAccessToken:()=>{var e=window.location;return window.location.href=e.pathname+e.hash,Promise.resolve("")}});var o={Analytics:{searchHub:"zd_"+t.product+"_"+t.location}};i&&(new h(e,{searchEndpoint:Coveo.SearchEndpoint.endpoints.default,organizationId:n.organizationId,restUri:t.endpointUrl}),o.UserActions={userId:i}),!1===t.autoTriggerQuery&&(o.SearchInterface={autoTriggerQuery:!1}),Coveo.init(e,o)}))}initializeSearchInterface(e,t){return d(this,void 0,void 0,(function*(){this.initializeSearchInterfaceWithUserActions(e,t,null)}))}}var p=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}a((n=n.apply(e,t||[])).next())}))};class v{constructor(e,t,i){this.options=t,this.zendeskClient=i,this.flattenFields=function(e,t){return t?Object.keys(t).filter(e=>"errors"!=e).reduce((i,n)=>{var o=t[n],s=""==e?n:e+"."+n,r=typeof o;return"object"==r?Object.assign(i,this.flattenFields(s,o)):"string"!=r&&"boolean"!=r&&"number"!=r||(i[s]=o),i},{}):{}},this.executeQuery=_.throttle(()=>{Coveo.logSearchEvent(this.root.el,{name:"CaseInputChange",type:"Search"},this.ticketContext),Coveo.executeQuery(this.root.el)},2e3),this.root=new r.Dom(e)}parseFieldList(e){return e?e.split(";"):[]}filterFields(e){return p(this,void 0,void 0,(function*(){var t=Object.keys(e),i=yield this.zendeskClient.getSettings(),n=this.parseFieldList(i.insightPanelFieldsAllowlist),o=this.parseFieldList(i.insightPanelFieldsBlocklist);return t.filter(e=>0==n.length||n.some(t=>new RegExp(t).test(e))).filter(e=>!o.some(t=>new RegExp(t).test(e))).reduce((t,i)=>(t[i]=e[i],t),{})}))}getTicketContext(){return p(this,void 0,void 0,(function*(){var e=yield this.zendeskClient.getTicketFields(),t=e.map(e=>"ticket."+e.name),i=yield this.zendeskClient.getClient().get(t),n={};e.forEach(e=>{n["ticket."+e.label]=i["ticket."+e.name]});var o=yield this.filterFields(this.flattenFields("",n));return Object.keys(o).reduce((e,t)=>(e[t.split(".").join("_")]=o[t],e),{})}))}computeHeight(){return window.outerHeight/2+"px"}bindCoveoEvents(e){return p(this,void 0,void 0,(function*(){var t=this;Coveo.$$(this.root).on("buildingQuery",(function(i,n){n.queryBuilder.addContext(t.ticketContext),e&&(n.queryBuilder.userActions={tagViewsOfUser:e})}))}))}setTicketContext(e){this.ticketContext=e,this.topBarClient&&this.topBarClient.trigger("ticket_context_updated",this.ticketContext)}bindZendeskEvents(){return p(this,void 0,void 0,(function*(){this.zendeskClient.getClient().on("*.changed",e=>{this.getTicketContext().then(e=>{this.setTicketContext(e),this.executeQuery()})}),this.zendeskClient.getClient().get("instances").then(e=>{var t=e.instances,i=Object.keys(t).filter(e=>"top_bar"==t[e].location).join("");return this.zendeskClient.getClient().instance(i)}).then(e=>{this.topBarClient=e}),this.zendeskClient.getClient().on("top_bar_loaded",()=>{this.setTicketContext(this.ticketContext)})}))}getRequesterEmail(){return p(this,void 0,void 0,(function*(){var e=yield this.zendeskClient.getClient().get("ticket.requester");if(e["ticket.requester"])return e["ticket.requester"].email}))}init(e){return p(this,void 0,void 0,(function*(){this.setTicketContext(yield this.getTicketContext()),this.bindZendeskEvents();var t=new f(this.zendeskClient),i=yield this.getRequesterEmail();e&&i?(this.bindCoveoEvents(i),t.initializeSearchInterfaceWithUserActions(this.root.el,this.options,i)):(this.bindCoveoEvents(null),t.initializeSearchInterface(this.root.el,this.options)),this.zendeskClient.getClient().invoke("resize",{width:"100%",height:this.computeHeight()})}))}}var C=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function c(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}a((n=n.apply(e,t||[])).next())}))};class g{constructor(e,t,i){this.options=t,this.zendeskClient=i,this.executeQuery=_.throttle(()=>{Coveo.logSearchEvent(this.root.el,{name:"CaseInputChange",type:"Search"},this.ticketContext),Coveo.executeQuery(this.root.el)},2e3),this.root=new r.Dom(e)}bindCoveoEvents(){return C(this,void 0,void 0,(function*(){var e=this;Coveo.$$(this.root).on("buildingQuery",(function(t,i){i.queryBuilder.addContext(e.ticketContext)}))}))}setTicketContext(e){this.ticketContext=e}bindZendeskEvents(){return C(this,void 0,void 0,(function*(){var e=this;this.zendeskClient.getClient().on("ticket_context_updated",t=>{e.setTicketContext(t),e.executeQuery()}),this.zendeskClient.getClient().get("instances").then(e=>{var t=e.instances,i=Object.keys(t).filter(e=>t[e].location.indexOf("ticket_sidebar")>=0).join("");return this.zendeskClient.getClient().instance(i)}).then(e=>{e.trigger("top_bar_loaded")})}))}init(){return C(this,void 0,void 0,(function*(){this.bindCoveoEvents(),this.bindZendeskEvents(),this.options.autoTriggerQuery=!0,new f(this.zendeskClient).initializeSearchInterface(this.root.el,this.options),this.zendeskClient.getClient().invoke("resize",{width:"1000px",height:"500px"})}))}}function y(e){var t=document.querySelector("#search");"support"==e.product&&e.location.indexOf("ticket_sidebar")>=0?new v(t,e,new o).init("new_ticket_sidebar"!=e.location):"support"==e.product&&"top_bar"==e.location&&new g(t,e,new o).init()}}])}));
//# sourceMappingURL=CoveoForZendesk.min.js.map